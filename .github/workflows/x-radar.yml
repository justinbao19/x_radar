name: X Radar Pipeline

on:
  schedule:
    # Run every 6 hours: 00:00, 06:00, 12:00, 18:00 UTC
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # Allow manual trigger

env:
  NODE_ENV: production

jobs:
  scrape-and-comment:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ===== Setup =====
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      # ===== Restore X Auth State =====
      - name: Restore X auth state
        env:
          X_STORAGE_STATE_B64: ${{ secrets.X_STORAGE_STATE_B64 }}
        run: |
          if [ -n "$X_STORAGE_STATE_B64" ]; then
            echo "Restoring auth state from secret..."
            mkdir -p auth
            echo "$X_STORAGE_STATE_B64" | base64 -d > auth/state.json
            echo "Auth state restored successfully"
          else
            echo "No X_STORAGE_STATE_B64 secret found, skipping auth restore"
          fi

      - name: Check auth state
        run: |
          if [ -f auth/state.json ]; then
            echo "✓ auth/state.json exists ($(stat -c%s auth/state.json 2>/dev/null || stat -f%z auth/state.json) bytes)"
          else
            echo "⚠ auth/state.json not found - scraping may be limited"
          fi

      # ===== Run Pipeline =====
      - name: Run scraper
        run: npm run scrape
        env:
          PLAYWRIGHT_HEADLESS: 'true'
        continue-on-error: false

      - name: Run selector
        run: npm run select
        continue-on-error: false

      - name: Run formatter
        run: npm run format
        continue-on-error: false

      - name: Run comment generator
        run: npm run comment
        env:
          LLM_API_URL: ${{ secrets.LLM_API_URL }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_MODEL: ${{ secrets.LLM_MODEL || 'claude-sonnet-4-20250514' }}
        continue-on-error: true  # Don't fail entire job if comments fail

      # ===== Output Summary =====
      - name: Show output summary
        if: always()
        run: |
          echo "=== Output Files ==="
          ls -la out/ 2>/dev/null || echo "No output directory"
          echo ""
          echo "=== raw.json stats ==="
          if [ -f out/raw.json ]; then
            node -e "const d=require('./out/raw.json'); console.log('Sources:', d.sources?.length || 0, 'Tweets:', d.stats?.totalTweets || 0)"
          else
            echo "raw.json not found"
          fi
          echo ""
          echo "=== top10.json stats ==="
          if [ -f out/top10.json ]; then
            node -e "const d=require('./out/top10.json'); console.log('Selected:', d.top?.length || 0)"
          else
            echo "top10.json not found"
          fi
          echo ""
          echo "=== top10_with_comments.json stats ==="
          if [ -f out/top10_with_comments.json ]; then
            node -e "const d=require('./out/top10_with_comments.json'); console.log('With comments:', d.commentGenerationStats?.succeeded || 0, '/', d.commentGenerationStats?.total || 0)"
          else
            echo "top10_with_comments.json not found"
          fi

      # ===== Upload Artifacts =====
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: x-radar-${{ github.run_number }}-${{ github.run_attempt }}
          path: |
            out/raw.json
            out/top10.json
            out/top10.md
            out/top10_with_comments.json
            out/top10_with_comments.md
          retention-days: 30
          if-no-files-found: warn
