name: X Radar Pipeline

on:
  schedule:
    # 数据抓取：每 6 小时运行一次
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # Allow manual trigger

concurrency:
  group: x-radar-pipeline
  cancel-in-progress: false

env:
  NODE_ENV: production

jobs:
  scrape-and-comment:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      issues: write

    steps:
      # ===== Setup =====
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      # ===== Restore X Auth State =====
      - name: Restore X auth state
        env:
          X_STORAGE_STATE_B64: ${{ secrets.X_STORAGE_STATE_B64 }}
        run: |
          if [ -n "$X_STORAGE_STATE_B64" ]; then
            echo "Restoring auth state from secret..."
            mkdir -p auth
            echo "$X_STORAGE_STATE_B64" | base64 -d > auth/state.json
            echo "Auth state restored successfully"
          else
            echo "No X_STORAGE_STATE_B64 secret found, skipping auth restore"
          fi

      - name: Check auth state
        run: |
          if [ -f auth/state.json ]; then
            echo "✓ auth/state.json exists ($(stat -c%s auth/state.json 2>/dev/null || stat -f%z auth/state.json) bytes)"
          else
            echo "⚠ auth/state.json not found - scraping may be limited"
          fi

      # ===== Run Pipeline =====
      - name: Run scraper
        id: scraper
        run: npm run scrape
        env:
          PLAYWRIGHT_HEADLESS: 'true'
        continue-on-error: true

      - name: Check scraper result and notify on auth failure
        if: steps.scraper.outcome == 'failure'
        run: |
          echo "Scraper failed, checking auth status..."
          if [ -f out/auth-status.json ]; then
            cat out/auth-status.json
            AUTH_VALID=$(node -e "console.log(require('./out/auth-status.json').valid)")
            if [ "$AUTH_VALID" = "false" ]; then
              echo "Auth failed, sending notifications..."
              npm run notify:auth-failed
            fi
          fi
          exit 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DASHBOARD_URL: ${{ secrets.DASHBOARD_URL }}

      - name: Run selector
        if: steps.scraper.outcome == 'success'
        run: npm run select
        continue-on-error: false

      - name: Run formatter
        if: steps.scraper.outcome == 'success'
        run: npm run format
        continue-on-error: false

      - name: Run translator
        if: steps.scraper.outcome == 'success'
        run: npm run translate
        env:
          LLM_API_URL: ${{ secrets.LLM_API_URL }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_MODEL: ${{ secrets.LLM_MODEL || 'claude-sonnet-4-20250514' }}
        continue-on-error: true  # Don't fail entire job if translation fails

      - name: Run commenter
        if: steps.scraper.outcome == 'success'
        run: npm run comment
        env:
          LLM_API_URL: ${{ secrets.LLM_API_URL }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_MODEL: ${{ secrets.LLM_MODEL || 'claude-sonnet-4-20250514' }}
        continue-on-error: true  # Don't fail entire job if comment generation fails

      # ===== Output Summary =====
      - name: Show output summary
        if: always()
        run: |
          echo "=== Output Files ==="
          ls -laR out/ 2>/dev/null || echo "No output directory"
          echo ""
          echo "=== raw.json stats ==="
          RAW_FILE=$(find out -name "raw.json" -type f 2>/dev/null | head -1)
          if [ -n "$RAW_FILE" ]; then
            node -e "const d=require('./$RAW_FILE'); console.log('Sources:', d.sources?.length || 0, 'Tweets:', d.stats?.totalTweets || 0)"
          else
            echo "raw.json not found"
          fi
          echo ""
          echo "=== top10.json stats ==="
          TOP10_FILE=$(find out -name "top10.json" -type f 2>/dev/null | head -1)
          if [ -n "$TOP10_FILE" ]; then
            node -e "const d=require('./$TOP10_FILE'); console.log('Selected:', d.top?.length || 0)"
          else
            echo "top10.json not found"
          fi
          echo ""
          echo "=== Translation stats ==="
          if [ -n "$TOP10_FILE" ]; then
            node -e "const d=require('./$TOP10_FILE'); const s=d.translationStats||{}; console.log('Translated:', s.translated || 0, '/ Skipped (zh):', s.skipped || 0, '/ Failed:', s.failed || 0)"
          else
            echo "No translation stats available"
          fi
          echo ""
          echo "=== Comment generation stats ==="
          COMMENT_FILE=$(find out -name "top10_with_comments.json" -type f 2>/dev/null | head -1)
          if [ -n "$COMMENT_FILE" ]; then
            node -e "const d=require('./$COMMENT_FILE'); const s=d.commentGenerationStats||{}; console.log('Total:', s.total || 0, '/ Succeeded:', s.succeeded || 0, '/ Skipped:', s.skipped || 0, '/ Failed:', s.failed || 0)"
          else
            echo "No comment stats available"
          fi

      # ===== Sync Data to Web =====
      # ===== Cleanup Expired Cache =====
      - name: Cleanup expired comment cache
        if: steps.scraper.outcome == 'success'
        run: |
          if [ -n "$NEXT_PUBLIC_SUPABASE_URL" ] && [ -n "$SUPABASE_SERVICE_KEY" ]; then
            curl -s -X POST "$NEXT_PUBLIC_SUPABASE_URL/rest/v1/rpc/cleanup_expired_comments" \
              -H "apikey: $SUPABASE_SERVICE_KEY" \
              -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
              -H "Content-Type: application/json" \
              -d '{}' || echo "Cache cleanup skipped (function may not exist)"
          else
            echo "Supabase not configured, skipping cache cleanup"
          fi
        env:
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        continue-on-error: true

      - name: Sync data to web
        if: steps.scraper.outcome == 'success'
        run: node scripts/sync-data.mjs

      # Pull latest changes before committing to minimize conflicts
      - name: Pull latest changes
        if: steps.scraper.outcome == 'success'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git stash --include-untracked || true
          git pull origin main --rebase || git pull origin main
          git stash pop || true

      - name: Re-sync data after pull
        if: steps.scraper.outcome == 'success'
        run: node scripts/sync-data.mjs

      - name: Commit and push data
        if: steps.scraper.outcome == 'success'
        run: |
          git add web/public/data/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "chore: update radar data [skip ci]"
          
          # Push with retry and conflict resolution
          PUSH_SUCCESS=false
          for i in 1 2 3; do
            echo "=== Push attempt $i ==="
            
            if git push; then
              PUSH_SUCCESS=true
              break
            fi
            
            echo "Push failed, pulling latest changes..."
            
            # Abort any pending rebase
            git rebase --abort 2>/dev/null || true
            
            # Stash our commit, pull latest, then re-apply
            git reset --soft HEAD~1
            git stash
            
            if git pull origin main; then
              git stash pop
              
              # Re-run sync to merge manifest.json properly
              node scripts/sync-data.mjs
              git add web/public/data/
              
              if ! git diff --staged --quiet; then
                git commit -m "chore: update radar data [skip ci]"
              fi
            else
              echo "Pull failed, trying harder..."
              git stash pop || true
            fi
            
            sleep 2
          done
          
          if [ "$PUSH_SUCCESS" = "false" ]; then
            echo "ERROR: Failed to push data after 3 attempts"
            exit 1
          fi
          
          echo "=== Push successful ==="

      # ===== Upload Artifacts =====
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: x-radar-${{ github.run_number }}-${{ github.run_attempt }}
          path: |
            out/latest/
            out/[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]/
          retention-days: 30
          if-no-files-found: warn

      # ===== Send Failure Notification =====
      - name: Send failure notification
        if: failure()
        run: npm run notify:failure
        env:
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          FAILURE_STEP: ${{ github.job }}
          FAILURE_ERROR: "Pipeline 执行过程中出现错误，请查看 Actions 日志"
          GITHUB_RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
