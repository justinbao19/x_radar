name: X Radar Pipeline

on:
  schedule:
    # Run every 6 hours: 00:00, 06:00, 12:00, 18:00 UTC
    - cron: '0 */6 * * *'
  workflow_dispatch:
    # Allow manual trigger

env:
  NODE_ENV: production

jobs:
  scrape-and-comment:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ===== Setup =====
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install chromium --with-deps

      # ===== Restore X Auth State =====
      - name: Restore X auth state
        env:
          X_STORAGE_STATE_B64: ${{ secrets.X_STORAGE_STATE_B64 }}
        run: |
          if [ -n "$X_STORAGE_STATE_B64" ]; then
            echo "Restoring auth state from secret..."
            mkdir -p auth
            echo "$X_STORAGE_STATE_B64" | base64 -d > auth/state.json
            echo "Auth state restored successfully"
          else
            echo "No X_STORAGE_STATE_B64 secret found, skipping auth restore"
          fi

      - name: Check auth state
        run: |
          if [ -f auth/state.json ]; then
            echo "✓ auth/state.json exists ($(stat -c%s auth/state.json 2>/dev/null || stat -f%z auth/state.json) bytes)"
          else
            echo "⚠ auth/state.json not found - scraping may be limited"
          fi

      # ===== Run Pipeline =====
      - name: Run scraper
        id: scraper
        run: npm run scrape
        env:
          PLAYWRIGHT_HEADLESS: 'true'
        continue-on-error: true

      - name: Check scraper result and notify on auth failure
        if: steps.scraper.outcome == 'failure'
        run: |
          echo "Scraper failed, checking auth status..."
          if [ -f out/auth-status.json ]; then
            cat out/auth-status.json
            AUTH_VALID=$(node -e "console.log(require('./out/auth-status.json').valid)")
            if [ "$AUTH_VALID" = "false" ]; then
              echo "Auth failed, sending notifications..."
              npm run notify:auth-failed
            fi
          fi
          exit 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NOTIFY_EMAIL: ${{ secrets.NOTIFY_EMAIL }}
          WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
          RESEND_API_KEY: ${{ secrets.RESEND_API_KEY }}

      - name: Run selector
        if: steps.scraper.outcome == 'success'
        run: npm run select
        continue-on-error: false

      - name: Run formatter
        if: steps.scraper.outcome == 'success'
        run: npm run format
        continue-on-error: false

      - name: Run comment generator
        if: steps.scraper.outcome == 'success'
        run: npm run comment
        env:
          LLM_API_URL: ${{ secrets.LLM_API_URL }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_MODEL: ${{ secrets.LLM_MODEL || 'claude-sonnet-4-20250514' }}
        continue-on-error: true  # Don't fail entire job if comments fail

      # ===== Output Summary =====
      - name: Show output summary
        if: always()
        run: |
          echo "=== Output Files ==="
          ls -laR out/ 2>/dev/null || echo "No output directory"
          echo ""
          echo "=== raw.json stats ==="
          RAW_FILE=$(find out -name "raw.json" -type f 2>/dev/null | head -1)
          if [ -n "$RAW_FILE" ]; then
            node -e "const d=require('./$RAW_FILE'); console.log('Sources:', d.sources?.length || 0, 'Tweets:', d.stats?.totalTweets || 0)"
          else
            echo "raw.json not found"
          fi
          echo ""
          echo "=== top10.json stats ==="
          TOP10_FILE=$(find out -name "top10.json" -type f 2>/dev/null | head -1)
          if [ -n "$TOP10_FILE" ]; then
            node -e "const d=require('./$TOP10_FILE'); console.log('Selected:', d.top?.length || 0)"
          else
            echo "top10.json not found"
          fi
          echo ""
          echo "=== top10_with_comments.json stats ==="
          COMMENTS_FILE=$(find out -name "top10_with_comments.json" -type f 2>/dev/null | head -1)
          if [ -n "$COMMENTS_FILE" ]; then
            node -e "const d=require('./$COMMENTS_FILE'); console.log('With comments:', d.commentGenerationStats?.succeeded || 0, '/', d.commentGenerationStats?.total || 0)"
          else
            echo "top10_with_comments.json not found"
          fi

      # ===== Sync Data to Web =====
      - name: Sync data to web
        if: steps.scraper.outcome == 'success'
        run: node scripts/sync-data.mjs

      - name: Commit and push data
        if: steps.scraper.outcome == 'success'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add web/public/data/
          git diff --staged --quiet || git commit -m "chore: update radar data [skip ci]"
          git push

      # ===== Upload Artifacts =====
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: x-radar-${{ github.run_number }}-${{ github.run_attempt }}
          path: |
            out/latest/
            out/[0-9][0-9][0-9][0-9]-[0-9][0-9]-[0-9][0-9]/
          retention-days: 30
          if-no-files-found: warn
